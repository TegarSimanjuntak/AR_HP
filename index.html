<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
   <title>index Web AR Example with Custom Marker</title>
   <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
   <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/1.7.2/aframe/build/aframe-ar.min.js"></script>
   <style>
      /* Gaya untuk tombol yang muncul saat marker ditemukan */
      #button {
         position: absolute;
         bottom: 80px;
         right: 20px;
         padding: 8px 16px;
         background-color: #007bff;
         color: white;
         border: none;
         border-radius: 5px;
         display: none;
         cursor: pointer;
         font-size: 14px;
      }
      /* Gaya untuk kotak informasi */
      #info-box {
         position: absolute;
         bottom: 150px;
         right: 20px;
         padding: 8px;
         background-color: rgba(0, 0, 0, 0.8);
         color: white;
         border-radius: 5px;
         display: none;
         font-size: 12px;
         max-width: 180px;
      }
      /* Gaya untuk hotspot */
      #annotation {
         position: absolute;
         width: 16px;
         height: 16px;
         background: rgba(255, 0, 0, 0.8);
         border-radius: 50%;
         cursor: pointer;
         display: none;
         z-index: 999;
      }
   </style>
</head>
<body style="margin: 0; overflow: hidden;">
   <a-scene embedded arjs>
      <a-marker preset="hiro" id="hiro-marker">
         <a-entity id="model" gltf-model="scene.gltf" scale="0.5 0.5 0.5" position="0 0 0"></a-entity>
      </a-marker>

      <a-entity id="locked-model" gltf-model="scene.gltf" scale="0.1 0.1 0.1" position="0 0 0" visible="false" rotation="0 0 0" class="interactable"></a-entity>
      <a-entity camera></a-entity>
   </a-scene>

   <button id="button" onclick="handleButtonClick()">Kunci</button>
   <div id="annotation"></div>
   <div id="info-box">Ini adalah informasi tentang model 3D.</div>
   <audio id="background-audio" src="audio.mp3" type="audio/mpeg"></audio>

   <script>
      const marker = document.querySelector("#hiro-marker");
      const button = document.getElementById("button");
      const lockedModel = document.querySelector("#locked-model");
      const audio = document.getElementById("background-audio");
      const infoBox = document.getElementById("info-box");
      const annotation = document.getElementById("annotation");
      let isLocked = false;

      marker.addEventListener("markerFound", () => {
         button.style.display = "block";
         audio.play();
         audio.loop = true;
      });

      marker.addEventListener("markerLost", () => {
         button.style.display = "none";
         audio.pause();
         audio.currentTime = 0;
         annotation.style.display = "none";
      });

      function handleButtonClick() {
         if (!isLocked) {
            lockedModel.setAttribute("visible", "true");
            lockedModel.setAttribute("position", { x: 0, y: -0.2, z: -2 });
            alert("Model terkunci dan ditampilkan.");
            lockedModel.setAttribute("rotation", { x: 0, y: -90, z: 0 });

            marker.setAttribute('visible', 'false');
            button.style.display = "none";
            annotation.style.display = "block";
         } else {
            lockedModel.setAttribute("visible", "false");
            alert("Model kembali ke posisi awal.");
            marker.setAttribute('visible', 'true');
            annotation.style.display = "none";
         }

         isLocked = !isLocked;
      }

      annotation.addEventListener('click', () => {
         infoBox.style.display = infoBox.style.display === "none" ? "block" : "none";
      });

      function updateAnnotationPosition() {
         if (isLocked) {
            const vector = new THREE.Vector3(0, 2, 0);
            vector.applyMatrix4(lockedModel.object3D.matrixWorld);
            vector.project(marker.object3D.el.sceneEl.camera);

            const x = (vector.x * 0.5 + 0.5) * window.innerWidth;
            const y = -(vector.y * 0.5 - 0.5) * window.innerHeight;

            annotation.style.left = `${x}px`;
            annotation.style.top = `${y}px`;
            annotation.style.display = "block";
         }
      }

      function animate() {
         requestAnimationFrame(animate);
         updateAnnotationPosition();
      }

      animate();

      let isDragging = false;
      let previousMousePosition = { x: 0, y: 0 };

      document.addEventListener('mousedown', (e) => {
         if (isLocked) {
            isDragging = true;
            previousMousePosition = { x: e.clientX, y: e.clientY };
         }
      });

      document.addEventListener('mouseup', () => {
         isDragging = false;
      });

      document.addEventListener('mousemove', (e) => {
         if (isDragging) {
            const deltaMove = {
               x: e.clientX - previousMousePosition.x,
               y: e.clientY - previousMousePosition.y
            };

            let currentRotation = lockedModel.getAttribute('rotation');
            const rotationSpeed = 0.2;

            lockedModel.setAttribute('rotation', {
               x: currentRotation.x - deltaMove.y * rotationSpeed,
               y: currentRotation.y + deltaMove.x * rotationSpeed,
               z: currentRotation.z
            });

            previousMousePosition = { x: e.clientX, y: e.clientY };
         }
      });

      let scaleFactor = 1;
      window.addEventListener('wheel', (event) => {
         if (isLocked) {
            event.preventDefault();
            scaleFactor += event.deltaY * -0.01;
            scaleFactor = Math.min(Math.max(0.1, scaleFactor), 3);

            lockedModel.setAttribute('scale', { x: scaleFactor, y: scaleFactor, z: scaleFactor });
         }
      });

      let lastTouchY = 0;
      window.addEventListener('touchstart', (event) => {
         if (isLocked) lastTouchY = event.touches[0].clientY;
      });

      window.addEventListener('touchmove', (event) => {
         if (isLocked) {
            const touchY = event.touches[0].clientY;
            const scaleChange = (touchY > lastTouchY) ? 1.02 : 0.98;
            scaleFactor *= scaleChange;
            scaleFactor = Math.min(Math.max(0.1, scaleFactor), 3);

            lockedModel.setAttribute('scale', { x: scaleFactor, y: scaleFactor, z: scaleFactor });
            lastTouchY = touchY;
         }
      });

      window.addEventListener("resize", () => {
         if (isLocked) updateAnnotationPosition();
      });
   </script>
</body>
</html>
